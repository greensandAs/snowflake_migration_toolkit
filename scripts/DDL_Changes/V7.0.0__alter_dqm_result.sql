USE DATABASE {{ snowflake_database }};
USE SCHEMA {{ snowflake_schema }};

ALTER TABLE DQ_RULE_RESULTS
ADD COLUMN FAILED_ROWS VARIANT;

ALTER TABLE DQ_RULE_RESULTS
ADD COLUMN SESSION_ID VARCHAR;

ALTER TABLE DQ_RULE_AUDIT_LOG
DROP COLUMN FAILED_ROWS;

ALTER TABLE DQ_RULE_AUDIT_LOG
DROP COLUMN SESSION_ID;

ALTER TABLE DQ_DATASET_COLUMN MODIFY COLUMN JUSTIFICATION ARRAY;

ALTER TABLE MICROSEGMENT_GENERATION_SESSION
ADD COLUMN IF NOT EXISTS DATASET_ID BIGINT;

ALTER TABLE MICROSEGMENT_DEFINITION
ADD COLUMN IF NOT EXISTS DATASET_ID BIGINT;

ALTER TABLE MICROSEGMENT_ANOMALIES
ADD COLUMN IF NOT EXISTS DATASET_ID BIGINT;

ALTER TABLE MICROSEGMENT_ATTRIBUTE
DROP COLUMN IF EXISTS DATASET_ID;

-- DROP TABLE IF EXISTS MICROSEGMENT_PROFILER_ATTRIBUTE_SUMMARY;
-- DROP TABLE IF EXISTS MICROSEGMENT_PROFILER_DATASET_SUMMARY;
-- DROP TABLE IF EXISTS MICROSEGMENT_DETAILS;


-- CREATE OR REPLACE TABLE KPI_DETAILS (
--     KPI_ID NUMBER(38, 0) NOT NULL,
--     KPI_NAME VARCHAR(250),
--     KPI_DESCRIPTION VARCHAR(2500),
--     KPI_GRANULARITY VARCHAR(250),
--     KPI_CALCULATION_METHOD VARCHAR(2500),
--     COLUMNS_USED VARCHAR(255),
--     CREATED_BY VARCHAR(100),
--     CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     UPDATED_BY VARCHAR(100),
--     UPDATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     DATASETS_USED VARCHAR(16777216),
--     PRIMARY KEY (KPI_ID)
-- );
-- CREATE OR REPLACE TABLE KPI_DATASET_MAPPING (
--     KPI_ID NUMBER(38, 0) NOT NULL,
--     DATASET_ID NUMBER(38, 0) NOT NULL,
--     KPI_DATASET_MAPPING_DESCRIPTION VARCHAR(250),
--     CREATED_BY VARCHAR(100),
--     CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     UPDATED_BY VARCHAR(100),
--     UPDATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     CONSTRAINT PK_KPI_DATASET_MAPPING PRIMARY KEY (KPI_ID, DATASET_ID),
--     CONSTRAINT FK_KPI_DATASET_MAPPING_DATASET FOREIGN KEY (DATASET_ID) REFERENCES DQ_DATASET (DATASET_ID)
-- );

-- CREATE OR REPLACE TABLE MICROSEGMENT_PROFILER_ATTRIBUTE_SUMMARY (
--     MICROSEGMENT_PROFILER_SNAPSHOT_ID NUMBER(38, 0) NOT NULL,
--     MICROSEGMENT_COLUMN_ID NUMBER(38, 0) NOT NULL,
--     MICROSEGMENT_DEF_ID NUMBER(38, 0) NOT NULL,
--     DATASET_ID NUMBER(38, 0) NOT NULL,
--     MICROSEGMENT_ATTRIBUTE_DISTINCT_COUNT NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_DISTINCT_PERCENTAGE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_IS_UNIQUE BOOLEAN,
--     MICROSEGMENT_ATTRIBUTE_UNIQUE_COUNT NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_UNIQUE_PERCENTAGE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_DATA_TYPE VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_IS_HASHABLE BOOLEAN,
--     MICROSEGMENT_VALUE_COUNTS_NON_NULL VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_VALUE_COUNTS_SORTED VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_IS_ORDERED BOOLEAN,
--     MICROSEGMENT_ATTRIBUTE_MISSING_COUNT NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_TOTAL_COUNT NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_MISSING_PERCENTAGE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_NON_NULL_COUNT NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_MEMORY_SIZE_BYTES NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_FIRST_FEW_ROWS VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_MAX_LENGTH NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_AVG_LENGTH NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_MEDIAN_LENGTH NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_MIN_LENGTH NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_LENGTH_DISTRIBUTION VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_HISTOGRAM_LENGTH VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_DISTINCT_CHARACTER_COUNT NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_TOTAL_CHARACTER_COUNT NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_CHARACTER_FREQUENCIES VARCHAR(16777216),
--     MICROSEGMENT_CATEGORY_ALIASES VARCHAR(16777216),
--     MICROSEGMENT_BLOCK_ALIASES VARCHAR(16777216),
--     MICROSEGMENT_BLOCK_ALIAS_FREQUENCIES VARCHAR(16777216),
--     MICROSEGMENT_BLOCK_ALIAS_COUNT NUMBER(38, 0),
--     MICROSEGMENT_BLOCK_ALIAS_CHARACTER_FREQUENCIES VARCHAR(16777216),
--     MICROSEGMENT_SCRIPT_FREQUENCIES VARCHAR(16777216),
--     MICROSEGMENT_SCRIPT_COUNT NUMBER(38, 0),
--     MICROSEGMENT_SCRIPT_CHARACTER_FREQUENCIES VARCHAR(16777216),
--     MICROSEGMENT_CATEGORY_ALIAS_FREQUENCIES VARCHAR(16777216),
--     MICROSEGMENT_CATEGORY_COUNT NUMBER(38, 0),
--     MICROSEGMENT_CATEGORY_ALIAS_CHARACTER_FREQUENCIES VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_WORD_FREQUENCIES VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_INFERRED_DATA_TYPE VARCHAR(16777216),
--     MICROSEGMENT_EXECUTION_DATE_START TIMESTAMP_NTZ(9),
--     MICROSEGMENT_EXECUTION_DATE_END TIMESTAMP_NTZ(9),
--     MICROSEGMENT_ATTRIBUTE_ALERT VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_NEGATIVE_COUNT NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_NEGATIVE_PERCENTAGE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_INFINITE_COUNT NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_ZERO_COUNT NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_MEAN_VALUE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_STD_DEV NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_VARIANCE_VALUE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_MIN_VALUE VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_MAX_VALUE VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_KURTOSIS_VALUE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_SKEWNESS_VALUE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_SUM_VALUE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_MEAN_ABSOLUTE_DEVIATION NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_CHI_SQUARED_TEST VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_VALUE_RANGE VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_PERCENTILE_5 NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_PERCENTILE_25 NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_PERCENTILE_50 NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_PERCENTILE_75 NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_PERCENTILE_95 NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_INTERQUARTILE_RANGE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_COEFFICIENT_OF_VARIATION NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_ZERO_PERCENTAGE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_INFINITE_PERCENTAGE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_MONOTONIC_INCREASING VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_MONOTONIC_DECREASING VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_STRICTLY_MONOTONIC_INCREASING VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_STRICTLY_MONOTONIC_DECREASING VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_MONOTONIC_TREND NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_VALUE_HISTOGRAM VARCHAR(16777216),
--     MICROSEGMENT_ATTRIBUTE_DATA_IMBALANCE NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_INVALID_DATE_COUNT NUMBER(38, 0),
--     MICROSEGMENT_ATTRIBUTE_INVALID_DATES_TOTAL NUMBER(18, 6),
--     MICROSEGMENT_ATTRIBUTE_INVALID_DATES_PERCENTAGE NUMBER(18, 6),
--     MICROSEGMENT_PROFILER_EXECUTION_DATE_START TIMESTAMP_NTZ(9),
--     MICROSEGMENT_PROFILER_EXECUTION_DATE_END TIMESTAMP_NTZ(9),
--     CREATED_BY VARCHAR(100),
--     CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     UPDATED_BY VARCHAR(100),
--     UPDATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     CONSTRAINT PK_MICROSEGMENT_PROFILER_ATTRIBUTE_SUMMARY PRIMARY KEY (
--         MICROSEGMENT_DEF_ID, DATASET_ID, MICROSEGMENT_PROFILER_SNAPSHOT_ID, MICROSEGMENT_COLUMN_ID
--     )
-- );
-- CREATE OR REPLACE TABLE MICROSEGMENT_PROFILER_DATASET_SUMMARY (
--     MICROSEGMENT_DEF_ID NUMBER(38, 0) NOT NULL,
--     DATASET_ID NUMBER(38, 0) NOT NULL,
--     MICROSEGMENT_PROFILER_SNAPSHOT_ID NUMBER(38, 0) NOT NULL,
--     KPI_ID NUMBER(38, 0),
--     MICROSEGMENT_TOTAL_RECORDS NUMBER(38, 0),
--     MICROSEGMENT_TOTAL_COLUMNS NUMBER(38, 0),
--     MICROSEGMENT_MEMORY_SIZE_BYTES NUMBER(38, 0),
--     MICROSEGMENT_AVG_RECORD_SIZE_BYTES FLOAT,
--     MICROSEGMENT_MISSING_VALUES_COUNT NUMBER(38, 0),
--     MICROSEGMENT_COLUMNS_WITH_MISSING_VALUES NUMBER(38, 0),
--     MICROSEGMENT_COLUMNS_FULLY_MISSING NUMBER(38, 0),
--     MICROSEGMENT_MISSING_VALUES_PERCENTAGE FLOAT,
--     MICROSEGMENT_COLUMN_DATA_TYPES VARCHAR(16777216),
--     MICROSEGMENT_DUPLICATE_RECORDS_COUNT NUMBER(38, 0),
--     MICROSEGMENT_DUPLICATE_RECORDS_PERCENTAGE FLOAT,
--     MICROSEGMENT_PROFILER_EXECUTION_DATE_START TIMESTAMP_NTZ(9),
--     MICROSEGMENT_PROFILER_EXECUTION_DATE_END TIMESTAMP_NTZ(9),
--     CREATED_BY VARCHAR(100),
--     CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     UPDATED_BY VARCHAR(100),
--     UPDATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     CONSTRAINT PK_SRC_MICROSEGMENT_PROFILER_DATASET_SUMMARY PRIMARY KEY (MICROSEGMENT_DEF_ID, DATASET_ID, MICROSEGMENT_PROFILER_SNAPSHOT_ID)
-- );
-- CREATE OR REPLACE TABLE MICROSEGMENT_DEFINITION (
--     MICROSEGMENT_DEF_ID NUMBER(38, 0) NOT NULL,
--     KPI_ID NUMBER(38, 0) NOT NULL,
--     MICROSEGMENT_DEF_NAME VARCHAR(16777216) NOT NULL,
--     MICROSEGMENT_DEF_DESCRIPTION VARCHAR(16777216),
--     CREATED_BY VARCHAR(100),
--     CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     UPDATED_BY VARCHAR(100),
--     UPDATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     DATASET_ID NUMBER(38, 0),
--     CONSTRAINT PK_MICROSEGMENT_DEF PRIMARY KEY (MICROSEGMENT_DEF_ID)
-- );


-- CREATE OR REPLACE TABLE MICROSEGMENT_DETAILS (
--     DATASET_ID NUMBER(38, 0) NOT NULL,
--     MICROSEGMENT_EXECUTION_DATE_START TIMESTAMP_NTZ(9) NOT NULL,
--     MICROSEGMENT_EXECUTION_DATE_END TIMESTAMP_NTZ(9) NOT NULL,
--     MICROSEGMENT_DEF_ID NUMBER(38, 0) NOT NULL,
--     MICROSEGMENT_ID NUMBER(38, 0) NOT NULL,
--     MICROSEGMENT_PROFILE VARIANT,
--     KPI_ID NUMBER(38, 0),
--     MICROSEGMENT_PROFILER_SNAPSHOT_ID NUMBER(38, 0) NOT NULL,
--     CONSTRAINT PK_MICROSEGMENT_DETAILS PRIMARY KEY (DATASET_ID, MICROSEGMENT_PROFILER_SNAPSHOT_ID, MICROSEGMENT_DEF_ID, MICROSEGMENT_ID)
-- );



-- CREATE OR REPLACE TABLE MICROSEGMENT_ATTRIBUTE (
--     MICROSEGMENT_DEF_ID NUMBER(38, 0) NOT NULL,
--     COLUMN_ID NUMBER(38, 0),
--     COLUMN_NAME VARCHAR(16777216) NOT NULL,
--     COLUMN_TYPE VARCHAR(16777216),
--     AGGREGATION_TYPE VARCHAR(16777216),
--     EXPLANATION VARCHAR(16777216),
--     FILTER_CONDITION VARCHAR(16777216),
--     CREATED_BY VARCHAR(100),
--     CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     UPDATED_BY VARCHAR(100),
--     UPDATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
-- );

-- CREATE OR REPLACE TABLE MICROSEGMENT_ANOMALIES (
--     MICROSEGMENT_PROFILER_SNAPSHOT_ID NUMBER(38, 0) NOT NULL,
--     MICROSEGMENT_DEF_ID NUMBER(38, 0) NOT NULL,
--     MICROSEGMENT_ID NUMBER(38, 0) NOT NULL,
--     KPI_ID NUMBER(38, 0) NOT NULL,
--     ANOMALY_DETECTION_METHOD VARCHAR(100) NOT NULL,
--     IS_WITHIN_ANOMALY BOOLEAN DEFAULT FALSE,
--     IS_ACROSS_ANOMALY BOOLEAN DEFAULT FALSE,
--     WITHIN_MICROSEGMENT_ANOMALY_REASON VARCHAR(16777216),
--     ACROSS_MICROSEGMENT_ANOMALY_REASON VARCHAR(16777216),
--     WITHIN_MICROSEGMENT_ANOMALY_CONFIDENCE_SCORE NUMBER(5, 2),
--     CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     UPDATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
--     ACROSS_MICROSEGMENT_ANOMALY_CONFIDENCE_SCORE NUMBER(5, 2),
--     DATASET_ID NUMBER(38, 0),
--     CONSTRAINT PK_MICROSEGMENT_ANOMALIES PRIMARY KEY (
--         KPI_ID, DATASET_ID, MICROSEGMENT_DEF_ID, MICROSEGMENT_ID, MICROSEGMENT_PROFILER_SNAPSHOT_ID, ANOMALY_DETECTION_METHOD
--     )
-- );
